\ProvidesPackage{ustj}

\usepackage[T1]{fontenc}
%\usepackage[utf8]{inputenc}

\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{calc} % for \heightof in \tombstone

\usepackage{mathspec}
\setmathtt[Scale=MatchLowercase]{Urbit Sans Mono TT SemiBold}
\usepackage[osf]{libertineRoman}
\newfontfamily\monofont{Urbit Sans Mono TT SemiBold}[Scale=MatchLowercase]
\renewcommand{\setmonofont}{\monofont}
\renewcommand{\texttt}[1]{{\monofont #1}}
% Define a new font family for small caps with FakeSlant
\newfontfamily\slantedsmallcapsfont{Linux Libertine O}[
    FakeSlant = 0.1 % Adjust the slant amount as needed
]
% Redefine \textsc to make small caps 25% larger
% \let\oldtextsc\textsc
% \renewcommand{\textsc}[1]{\scalebox{1.25}{\oldtextsc{#1}}}
\newcommand{\ssc}[1]{{\slantedsmallcapsfont\textsc{#1}}}

\usepackage{listings}
\usepackage[dvipsnames]{xcolor}
\lstdefinelanguage{Hoon}
{
  alsoletter={
    ~!@\#\$\%^&*-_=+:;<>\,.?/|`"'\\
  },
  keywords={
    |_, |\%, |@, |:, |., |-, |^, |~, |*, |=, |?, |\$,
    \$@, \$_, \$:, \$\%, \$<, \$>, \$|, \$\&, \$^, \$~, \$-, \$=, \$?, \$;,
    \%_, \%., \%^, \%+, \%-, \%:, \%~, \%*, \%=,
    :_, :^, :+, :-, :~, :*,
    .+, .*, .=, .?, .^,
    --, ==,
    ^|, ^., ^-, ^+, ^\&, ^~, ^=, ^?, ^*, ^:,
    ~|, ~\$, ~_, ~\%, ~/, ~<, ~>, ~+, ~\&, ~?, ~=, ~!,
    ;:, ;/, ;<, ;~, ;;, ;+, ;*, ;=,
    =|, =., =?, =^, =:, =/, =;, =<, =>, =-, =*, =\,, =+, =~,
    ?|, ?:, ?., ?<, ?>, ?-, ?^, ?=, ?\#, ?+, ?\&, ?@, ?~, ?!,
    !:, !., !\,, !;, !>, !<, !@, !=, !?, !!,
    /?, /-, /+, /=, /\%, /\$, /*,
    +|, +\$, ++, +*,
  },
  morekeywords={
    @, @c, @d, @da, @dr, @f, @i, @if, @is, @n, @p, @q, @r, @rh, @rs, @rd, @rq, @s, @sb, @sd, @sv, @sw, @sx, @t, @ta, @tas, @u, @ub, @uc, @ud, @uv, @uw, @ux
    unit, cord, arch, tape, list, map, set
  },
  sensitive=true,
  morecomment=[l]{::},
  morestring=[b]",
  morestring=[d]'
}
\lstdefinestyle{inlinecode}{
    language=Hoon,
    basicstyle=\setmonofont,
    tabsize=2,
    columns=fixed,
    showstringspaces=false,
    showtabs=false,
    showspaces=false,
    keepspaces,
    upquote=true,
    breaklines=true,
    breakatwhitespace=true,
    commentstyle=\color{Gray}\emph,
    keywordstyle=\bfseries
}
\lstdefinestyle{listingcode}{
    language=Hoon,
    basicstyle=\setmonofont\small,
    numbers=left, numberstyle=\tiny, stepnumber=5, firstnumber=1, numberfirstline=false,
    frame=tb,
    tabsize=2,
    columns=fixed,
    showstringspaces=false,
    showtabs=false,
    showspaces=false,
    keepspaces,
    upquote=true,
    commentstyle=\color{Gray}\emph,
    keywordstyle=\color{darkgray}\bfseries
}
\lstdefinestyle{listingblock}{
    language=Hoon,
    basicstyle=\setmonofont\small,
    numbers=left, numberstyle=\tiny, stepnumber=5, firstnumber=1, numberfirstline=false,
    tabsize=2,
    columns=fixed,
    showstringspaces=false,
    showtabs=false,
    showspaces=false,
    keepspaces,
    upquote=true,
    commentstyle=\color{Gray}\emph,
    keywordstyle=\color{darkgray}\bfseries
}
\lstdefinestyle{listingcode_python}{
    language=Python,
    basicstyle=\setmonofont\small,
    numbers=left, numberstyle=\tiny, stepnumber=5, firstnumber=1, numberfirstline=false,
    frame=tb,
    tabsize=2,
    columns=fixed,
    showstringspaces=false,
    showtabs=false,
    showspaces=false,
    keepspaces,
    upquote=true,
    commentstyle=\color{Gray}\emph,
    keywordstyle=\color{darkgray}\bfseries
}
\lstdefinestyle{listingcode_c}{
    language=C,
    basicstyle=\setmonofont\small,
    numbers=left, numberstyle=\tiny, stepnumber=5, firstnumber=1, numberfirstline=false,
    frame=tb,
    tabsize=2,
    columns=fixed,
    showstringspaces=false,
    showtabs=false,
    showspaces=false,
    keepspaces,
    upquote=true,
    commentstyle=\color{Gray}\emph,
    keywordstyle=\color{darkgray}\bfseries
}


\usepackage{titlesec}
\newfontfamily\urbitfont{Urbit Sans TT SemiBold}
\titleformat{\section}{\urbitfont\Large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}{\urbitfont\large\bfseries}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\urbitfont\normalsize\bfseries}{\thesubsubsection}{1em}{}
\titleformat{\paragraph}[runin]{\urbitfont\normalsize\bfseries}{\theparagraph}{1em}{}
\usepackage{titling}
\renewcommand{\maketitlehooka}{\urbitfont\bfseries}
% Redefine the format of the abstract heading to make it invisible
\AtBeginDocument{\renewcommand{\abstractname}{}}

%% Page size
% \usepackage[paperheight=8.5in,paperwidth=5.5in,margin=1in,heightrounded,showframe]{geometry}
\usepackage[paperheight=8.5in,paperwidth=5.5in,margin=1in,heightrounded]{geometry}

%% Configure first-page footer and later-page header.
\usepackage{fancyhdr}

\setlength{\headheight}{15.2pt}
\pagestyle{fancy}

\newcommand{\patp}[1]{\texttt{\textasciitilde#1}}
\newcommand{\github}[1]{\texttt{@#1}}

% Turn off when producing release version.
\usepackage{lineno}
% \linenumbers

% Bibliography management
\usepackage[
    backend=biber,
    style=authoryear-icomp,
    sortlocale=en_US,
    natbib=true,
    url=true,
    eprint=false
]{biblatex}
\usepackage[hidelinks,breaklinks=true]{hyperref}
\renewcommand\UrlFont{\monofont}
\renewcommand{\UrlBreaks}{\do\/\do-}

% Patch the \bibsetup command to set the bibliography to be ragged-right
\usepackage{etoolbox}
\appto{\bibsetup}{\raggedright\small}

% Define a command to check for usera field and use it if available
\makeatletter
\newcommand{\iffieldundef}[3]{%
  \@ifundefined{abx@field@#1}{#2}{#3}%
}
\makeatother
\newcommand{\citeauthorhandle}[1]{%
  \iffieldundef{usera}
    {\citeauthor{#1}}
    {\printfield{usera}}%
}

% Redefine \citep and \citet
\renewcommand{\citep}[1]{(\citeauthorhandle{#1}, \citeyear{#1})}
\renewcommand{\citet}[1]{\citeauthorhandle{#1} (\citeyear{#1})}

% Define a new date format
\usepackage[USenglish]{babel}
\DefineBibliographyExtras{USenglish}{%
  % yyyya format for long dates
  \protected\def\mkbibdatelong#1#2#3{%
    \iffieldundef{#1}{}{\stripzeros{\thefield{#1}}}%
  }%
  % ~yyyy.mm.dd format for short dates
  \protected\def\mkbibdateshort#1#2#3{%
    \textasciitilde
    \iffieldundef{#1}{}{\stripzeros{\thefield{#1}}}%
    .%
    \iffieldundef{#2}{}{\stripzeros{\thefield{#2}}}%
    .%
    \iffieldundef{#3}{}{\stripzeros{\thefield{#3}}}%
  }%
}

% Define a command to enclose the title in quotation marks
\newcommand{\quotetitle}[1]{``#1''}

% Use the command to enclose the title for @online and @software entries
\DeclareFieldFormat[online]{title}{\quotetitle{#1}}
\DeclareFieldFormat[software]{title}{\quotetitle{#1}}
\DeclareFieldFormat[techreport]{techreport}{\quotetitle{#1}}
\DeclareFieldFormat[online]{titleaddon}{#1} % Adjust the formatting of titleaddon

\newcommand{\tombstone}{\resizebox{!}{\heightof{T}}{\includegraphics{ustj-logo}}}

% Define a custom citation command for GitHub PRs
\DeclareCiteCommand{\citetpr}
  {\usebibmacro{prenote}}
  {\usebibmacro{citeindex}%
   \printtext[bibhyperref]{\printfield{usera}}}
  {\multicitedelim}
  {\usebibmacro{postnote}}

% Define a custom citation command for GitHub PRs
\DeclareCiteCommand{\citetrepo}
{\usebibmacro{prenote}}
{\usebibmacro{citeindex}%
 \printtext[bibhyperref]{\printfield{usera}}}
{\multicitedelim}
{\usebibmacro{postnote}}

% Define the custom citation command for @online entries
\DeclareCiteCommand{\customonlinecite}
  {\usebibmacro{prenote}}
  {\printnames{author}%
   \setunit{\addcomma\space}%
   \printfield{title}%
   \setunit{\addcomma\space}%
   (\printfield{year}).\space
   \printfield{titleaddon}%
   \setunit{\addperiod\space\textsc{url}\addcolon\space}%
   \texttt{\url{\thefield{url}}}%
   \setunit{\addspace(visited on\space}%
   \printdate% Print the access date
   \setunit{\addcomma\space}\bibstring{urlseen}\addperiod\space}%
  {\multicitedelim}
  {\usebibmacro{postnote}}

% Use the custom citation command for @online entries
\DeclareFieldFormat[online]{titleaddon}{#1} % Adjust the formatting of titleaddon
\DeclareBibliographyDriver{online}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author/editor}%
  \setunit{\addspace}%
  \usebibmacro{title}%
  \newunit\newblock
  \printfield{titleaddon}% Print titleaddon
  \newunit\newblock
  \usebibmacro{url+urldate}%
  \newunit\newblock
  \iftoggle{bbx:related}
    {\usebibmacro{related:init}%
     \usebibmacro{related}}
    {}%
  \usebibmacro{finentry}}

% Define the custom citation command for @software entries
\DeclareBibliographyDriver{software}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author/editor}%
  \setunit{\addspace}%
  \usebibmacro{title}%
  \newunit\newblock
  \usebibmacro{url+urldate}%
  \newunit\newblock
  \iftoggle{bbx:related}
    {\usebibmacro{related:init}%
     \usebibmacro{related}}
    {}%
  \usebibmacro{finentry}}

% Redefine the bibliography driver for @techreport entries
\DeclareBibliographyDriver{techreport}{%
    \usebibmacro{bibindex}%
    \usebibmacro{begentry}%
    \usebibmacro{author/editor}%
    \setunit{\addspace}%
    \printfield{title}%
    \newunit\newblock
    \usebibmacro{url}%
    \newunit\newblock
    \usebibmacro{finentry}%
}

\hfuzz=0.1pt % Adjust the value as needed
\hbadness=10000 % This value disables any reporting of overfull boxes
